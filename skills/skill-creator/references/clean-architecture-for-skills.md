# Clean Architecture for Skill Design

> **読み込み条件**: スキル設計時、構造計画時、品質検証時
> **相対パス**: `references/clean-architecture-for-skills.md`

---

## 目的

Clean Architecture（Robert C. Martin）の依存関係ルールと層分離思考をスキル設計に適用し、
変更に強く、テスト可能で、本質的な価値に集中したスキルを設計する。

---

## 1. スキルにおける4層アーキテクチャ

```
┌──────────────────────────────────────────────┐
│            External（外部層）                │
│  scripts/ assets/ 外部API・ファイルI/O       │
├──────────────────────────────────────────────┤
│         Interface Adapters（接続層）          │
│  agents/*.md  schemas/*.json                 │
├──────────────────────────────────────────────┤
│           Use Cases（用途層）                 │
│  SKILL.md ワークフロー定義                   │
├──────────────────────────────────────────────┤
│           Entities（中核層）                  │
│  Core Domain: 不変の業務ルール・原則         │
│  references/ (ドメイン知識)                   │
└──────────────────────────────────────────────┘
```

### 1.1 依存関係ルール（Dependency Rule）

**内側の層は外側の層を知らない。依存は常に外→内の方向のみ。**

| 層                 | 知ってよい対象       | 知ってはいけない対象    |
| ------------------ | -------------------- | ----------------------- |
| Entities           | ドメインルールのみ   | 具体的なスクリプト・API |
| Use Cases          | Entities             | 特定のスクリプト実装    |
| Interface Adapters | Entities + Use Cases | 外部APIの詳細           |
| External           | すべて               | -                       |

### 1.2 各層の責務

| 層                 | スキル内での役割                 | 具体的な成果物              |
| ------------------ | -------------------------------- | --------------------------- |
| Entities           | スキルの存在理由・不変のルール   | references/内のドメイン知識 |
| Use Cases          | ユーザーが達成すべきこと         | SKILL.mdのワークフロー定義  |
| Interface Adapters | 入出力の変換・エージェントの制御 | agents/_.md, schemas/_.json |
| External           | 決定論的処理・外部世界との接続   | scripts/_.js, assets/_      |

---

## 2. スキル設計への適用

### 2.1 Entities層: 何が「不変」か？

スキルが技術スタック・実装手段に関係なく保持すべきルール。

**質問**:

- このスキルが存在する理由は何か？（Why）
- 技術が変わっても変わらない原則は何か？
- このスキルのユーザーにとっての「正しさ」の定義は何か？

**出力例**:

```markdown
## Entities（不変ルール）

- PRは単一責務であるべき（1 PR = 1 目的）
- レビューコメントは具体的な改善提案を含むべき
- 品質基準はチームで合意されたものに従う
```

### 2.2 Use Cases層: ユーザーは何を達成するか？

スキルのワークフロー = ユースケースの集合体。

**設計原則**:

| 原則                         | 説明                                   |
| ---------------------------- | -------------------------------------- |
| Use Case = 1アクター + 1目標 | 1つのワークフローは1つの目標を達成する |
| Input/Output明確化           | 各ユースケースの入出力を定義する       |
| 代替フロー考慮               | 正常系だけでなく異常系も定義する       |

**テンプレート**:

```
ユースケース: {{名前}}
アクター: {{誰が使うか}}
事前条件: {{何が揃っていれば開始できるか}}
主フロー:
  1. {{ステップ1}}
  2. {{ステップ2}}
代替フロー:
  2a. {{ステップ2で失敗した場合}}
事後条件: {{完了後の状態}}
```

### 2.3 Interface Adapters層: どう変換するか？

agents/\*.md がこの層の中心。入力を受けてEntities/Use Casesに渡し、結果を出力形式に変換する。

**設計チェック**:

| チェック                            | 意味                               |
| ----------------------------------- | ---------------------------------- |
| agentはロジックを持たないか？       | ロジックはEntities/Use Casesに委譲 |
| agentは入出力変換に集中しているか？ | 変換・整形・フォーマット処理       |
| schemaは契約を明確にしているか？    | 入出力の型・制約が定義されている   |

### 2.4 External層: 外部世界との接続

scripts/_.js, assets/_ が担当。具体的な技術実装。

**設計原則**:

- スクリプトは「何を」ではなく「どのように」に集中する
- 入出力はスキーマで定義されたインターフェースに準拠する
- スクリプトの変更がEntities/Use Casesに影響しない

---

## 3. 高精度スキルのための設計チェックリスト

### 3.1 構造の健全性

| チェック項目                          | 検証方法                                  |
| ------------------------------------- | ----------------------------------------- |
| Core Domainが明確に定義されているか   | references/に不変ルールが文書化されている |
| Use Casesが具体的か                   | SKILL.mdのワークフローが明確              |
| 各agentの責務が単一か                 | 1 agent = 1 変換タスク                    |
| scriptsがEntityに依存していないか     | scripts内にドメイン判断ロジックがない     |
| schemasが全データフローをカバーするか | 入出力にスキーマ定義がある                |

### 3.2 精度を高める設計パターン

| パターン               | 説明                                     | 効果                 |
| ---------------------- | ---------------------------------------- | -------------------- |
| Contract First         | JSON Schemaを先に定義、実装は後          | 入出力の齟齬を防止   |
| Fail Fast              | 不正入力は最初の層で拒否                 | 後工程のエラーを削減 |
| Single Source of Truth | 1つの情報には1つの正本                   | 不整合の排除         |
| Explicit Over Implicit | 暗黙の前提を排除し、すべてを明示的に定義 | 曖昧さの排除         |
| Separation of Concerns | 各ファイルが1つの関心事のみ担当          | 変更影響の局所化     |
| Dependency Inversion   | 具体実装ではなく抽象（Schema）に依存     | 柔軟な実装変更       |

### 3.3 品質ゲート

各Phase移行時に実施する品質チェック:

| Phase移行     | 検証内容                                    |
| ------------- | ------------------------------------------- |
| 問題→ドメイン | Problem-Solution Fitが成立しているか        |
| ドメイン→設計 | Core Domainが特定され境界が明確か           |
| 設計→実装     | Use Cases、入出力スキーマが定義されているか |
| 実装→検証     | 全スクリプトが決定論的か、スキーマ準拠か    |
| 検証→完了     | エンドツーエンドで動作するか                |

---

## 4. Anti-Patterns（避けるべきパターン）

| Anti-Pattern          | 症状                             | 解決策                         |
| --------------------- | -------------------------------- | ------------------------------ |
| God Skill             | SKILL.mdが巨大で何でもする       | 責務を分解し複数スキルに分割   |
| Leaky Abstraction     | agentにドメインロジックが漏洩    | ロジックをreferencesに外部化   |
| Shotgun Surgery       | 1変更で多数ファイルを修正        | 責務の凝集度を見直す           |
| Primitive Obsession   | スキーマなしで生データを受け渡し | JSON Schemaによる型定義を追加  |
| Feature Envy          | agentが他スキルの内部構造に依存  | Published Languageで疎結合化   |
| Premature Abstraction | 使用前からの過度な汎用化         | 具体的なユースケースから抽象化 |

---

## 5. スキル品質の定量指標

| 指標               | 測定方法                          | 目安             |
| ------------------ | --------------------------------- | ---------------- |
| 責務凝集度         | 1ファイルあたりの関心事の数       | 1が理想          |
| 結合度             | ファイル間の直接参照数            | 低いほどよい     |
| Core Domain比率    | Core / 全ドメインのコード量比     | 最重要部分が厚い |
| スキーマカバレッジ | スキーマ定義済み / 全データフロー | 100%が理想       |
| ワークフロー明確度 | 曖昧なステップ数 / 全ステップ数   | 0が理想          |

---

## 関連リソース

- **問題発見**: See [problem-discovery-framework.md](problem-discovery-framework.md)
- **ドメインモデリング**: See [domain-modeling-guide.md](domain-modeling-guide.md)
- **品質基準**: See [quality-standards.md](quality-standards.md)
- **構造仕様**: See [skill-structure.md](skill-structure.md)
