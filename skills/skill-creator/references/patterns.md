# 実行パターン集

> **読み込み条件**: スキル実行時、改善検討時
> **更新タイミング**: パターンを発見したら追記

---

## 成功パターン

成功した実行から学んだベストプラクティス。

### Collaborative First による要件明確化

- **状況**: ユーザーの要求が抽象的（L1/L2レベル）
- **アプローチ**: AskUserQuestion でインタビューを実施し、段階的に具体化
- **結果**: 要件の認識齟齬を防ぎ、手戻りを削減
- **適用条件**: 抽象度が高い要求、複数の解釈が可能な場合
- **発見日**: 2026-01-15

### Script First によるメトリクス収集

- **状況**: フィードバック分析でデータ収集が必要
- **アプローチ**: collect_feedback.js でメトリクスを収集し、LLMは解釈のみ担当
- **結果**: 100%正確なデータに基づく改善提案が可能
- **適用条件**: 定量的なデータが必要な処理
- **発見日**: 2026-01-13

### 詳細情報の分離によるSKILL.md最適化

- **状況**: SKILL.mdが500行制限を超過（521行）
- **アプローチ**:
  - Part 0.5: 詳細フローチャートをexecution-mode-guide.mdへ移動（86行→30行）
  - scripts/: 5テーブルを1テーブル+参照リンクへ統合（54行→14行）
- **結果**: 521行→420行に削減（101行削減、19.4%減）
- **適用条件**: Progressive Disclosure対象の詳細情報が肥大化した場合
- **発見日**: 2026-01-20

### 大規模DRYリファクタリング

- **状況**: SKILL.md 481行、interview-user.md 398行と肥大化
- **アプローチ**:
  - SKILL.md: 詳細ワークフローをreferencesに委譲、エントリポイントと参照のみに
  - orchestration-guide.md: 実行モデル重複をworkflow-patterns.mdへの参照に
  - interview-user.md: 質問テンプレートをinterview-guide.mdへの参照に
- **結果**: SKILL.md 69%削減（481→149行）、interview-user.md 52%削減（398→191行）
- **適用条件**: 300行超のファイルで詳細とサマリーが混在している場合
- **発見日**: 2026-01-24

### Phase仕様書の成果物名厳密化

- **状況**: Phase 12実行時に仕様書と異なるファイル名で成果物を生成
- **アプローチ**:
  - Phase仕様書の成果物セクションにファイル名パターンを明記
  - 実行前に成果物一覧を確認するチェックリストを追加
- **結果**: 仕様書どおりの成果物が生成され、検証が容易に
- **適用条件**: Phase実行時、特に複数成果物を持つPhase
- **発見日**: 2026-01-22
- **関連タスク**: SHARED-TYPE-EXPORT-01

### スキル間ドキュメント整合性の定期確認

- **状況**: task-specification-creatorのSKILL.mdとreferences/artifact-naming-conventions.mdでPhase 12成果物リストが不整合
- **アプローチ**:
  - SKILL.mdの成果物定義を正とし、references/を同期
  - 改善作業時に関連ドキュメントの整合性を確認
- **結果**: artifact-naming-conventions.mdにPhase 12の3成果物（implementation-guide.md, documentation-update-log.md, unassigned-task-report.md）を追加
- **適用条件**: スキル改善時、バージョンアップ時
- **発見日**: 2026-01-22
- **関連タスク**: SHARED-TYPE-EXPORT-01

### 既存アダプターパターンの活用（新規API統合時）

- **状況**: システムプロンプトのLLM API統合時、仕様書ではVercel AI SDK使用を提案
- **アプローチ**:
  - 既存のLLMAdapterFactoryパターンを調査・活用
  - 新規SDKを追加せず、既存アダプター経由で4プロバイダー（OpenAI, Anthropic, Google, xAI）に対応
  - buildMessages()でシステムプロンプトをLLMMessage[]に変換
- **結果**: 既存アーキテクチャとの一貫性を維持、依存関係を最小化、54テスト全PASS
- **適用条件**: LLM機能追加時、外部API統合時
- **発見日**: 2026-01-23
- **関連タスク**: TASK-CHAT-SYSPROMPT-LLM-001

### システム仕様書への完了タスク記録

- **状況**: Phase 12 Task 2でシステム仕様書更新が必要
- **アプローチ**:
  - 該当するinterfaces-\*.mdに「完了タスク」セクションを追加
  - タスクID、概要、実装日、主要成果を記録
  - 「関連ドキュメント」に実装ガイドリンクを追加
- **結果**: タスク完了の追跡可能性が向上、後続開発者が実装履歴を把握可能
- **適用条件**: Phase 12実行時、機能追加完了時
- **発見日**: 2026-01-23
- **関連タスク**: TASK-CHAT-SYSPROMPT-LLM-001

### Phase 12 Task 2の見落とし防止

- **状況**: Phase 12 Task 2（システム仕様書更新）が実行されずにPhase 12完了とマークされた
- **アプローチ**:
  - phase-templates.mdのPhase 12完了条件に明示的チェックリスト追加
  - 【Phase 12-2 Step 1】等のプレフィックス付与で視認性向上
  - spec-update-workflow.mdへの参照リンクをテンプレート内に埋め込み
  - フォールバック手順セクションを追加
- **結果**: 2ステップ（タスク完了記録＋システム仕様更新）の実行漏れを防止
- **適用条件**: Phase 12実行時、特に複数サブタスクを持つPhase
- **発見日**: 2026-01-22
- **関連タスク**: UT-007 ChatHistoryProvider App Integration

### Phase 12 Step 1 検証スクリプトによる自動化

- **状況**: Phase 12 Step 1（必須タスク完了記録）が正しく実行されたか手動確認が困難
- **アプローチ**:
  - `validate-phase12-step1.js` スクリプトを作成し、必須要件を自動検証
  - 検証項目: 完了タスクセクション、実装ガイドリンク、変更履歴エントリ
  - SKILL.mdに検証コマンドを追加し、Phase 12完了前に実行を促す
- **結果**: 必須要件の漏れを自動検出、Phase 12完了前に問題を発見可能
- **適用条件**: Phase 12 Task 12-2 実行時、システム仕様書更新後の検証
- **発見日**: 2026-01-23
- **関連タスク**: SHARED-TYPE-EXPORT-03
- **検証コマンド**: `node .claude/skills/task-specification-creator/scripts/validate-phase12-step1.js --workflow <dir> --spec <file>`

### 複数システム仕様書への横断的更新

- **状況**: 単一タスクが複数の仕様書に関連する場合の更新漏れ
- **アプローチ**:
  - 関連仕様書を事前にリストアップ（例: interfaces-rag-community-detection.md + architecture-monorepo.md）
  - 各仕様書に対して Phase 12 Step 1 検証スクリプトを実行
  - spec-update-record.md に全更新対象を明記
- **結果**: 関連する全仕様書に一貫した完了タスク記録と実装ガイドリンクを追加
- **適用条件**: アーキテクチャ横断的な実装タスク、型エクスポート/インポートパターン変更時
- **発見日**: 2026-01-23
- **関連タスク**: SHARED-TYPE-EXPORT-03

---

## 失敗パターン（避けるべきこと）

失敗から学んだアンチパターン。

### 成果物名の暗黙的解釈

- **状況**: Phase 12で`implementation-guide.md`を`documentation.md`として生成
- **問題**: 仕様書との不整合、後続処理でのファイル参照エラー
- **原因**: 仕様書の成果物名を正確に確認せず暗黙的に命名
- **教訓**: Phase仕様書の「成果物」セクションを必ず確認し、ファイル名を厳密に一致させる
- **発見日**: 2026-01-22

### Phase 12サブタスクの暗黙的省略

- **状況**: Phase 12完了時に「実装ガイド作成」のみ実行し、「システム仕様書更新」を省略
- **問題**: システム仕様書に完了記録が残らず、成果が追跡できない
- **原因**: Phase 12が複数サブタスク（12-1, 12-2, 12-3）を持つことの認識不足
- **教訓**: Phase 12実行時は必ずサブタスク一覧を確認し、全タスクの実行を確認する
- **発見日**: 2026-01-22
- **対策済み**: phase-templates.md v7.6.0で完了条件チェックリストを強化

### 全リソース一括読み込み

- **状況**: スキル実行開始時に全ファイルを読み込んだ
- **問題**: コンテキストウィンドウを圧迫し、精度低下
- **原因**: Progressive Disclosure 原則の未適用
- **教訓**: 必要な時に必要なリソースのみ読み込む
- **発見日**: 2026-01-10

### LLMでのメトリクス計算

- **状況**: 成功率や実行回数をLLMに計算させた
- **問題**: 計算ミスが発生、信頼性低下
- **原因**: Script First 原則の未適用
- **教訓**: 決定論的処理は必ずスクリプトで実行
- **発見日**: 2026-01-08

### スクリプトでのデータ形式前提の誤り

- **状況**: generate-documentation-changelog.jsがartifacts.jsonを解析してエラー発生
- **問題**: `TypeError: The "path" argument must be of type string. Received undefined`
- **原因**: スクリプトは`{path, description}`オブジェクト形式を想定したが、実際は文字列配列形式だった
- **教訓**: スクリプト作成時は実際のデータ形式を確認し、複数形式に対応するか明確に文書化する
- **対策**: `typeof artifact === "string" ? artifact : artifact.path` で両形式に対応
- **発見日**: 2026-01-22
- **関連タスク**: skill-import-store-persistence (SKILL-STORE-001)

### 「検証タスク」でのPhase 12 Step 1省略

- **状況**: SHARED-TYPE-EXPORT-03（検証タスク）でPhase 12 Step 1を「検証タスクなので更新不要」と判断し省略
- **問題**: spec-update-record.mdに「更新不要」と記載したが、Step 1は必須要件だった
- **原因**: Step 1（タスク完了記録：必須）とStep 2（インターフェース仕様更新：条件付き）の区別を誤認
- **教訓**: Phase 12 Step 1（完了タスクセクション追加、実装ガイドリンク追加、変更履歴追記）は**検証タスクでも必須**
- **対策**:
  - task-specification-creator SKILL.mdに「【検証タスクでも必須】」警告を追加
  - validate-phase12-step1.js検証スクリプトで自動チェック
- **発見日**: 2026-01-23
- **関連タスク**: SHARED-TYPE-EXPORT-03

### ES Module互換性の確認漏れ

- **状況**: 新規スクリプト（validate-phase12-step1.js）作成時にCommonJS構文（require）を使用
- **問題**: プロジェクトがES Module（"type": "module"）設定のため実行時エラー
- **原因**: package.jsonの"type"フィールドを確認せずスクリプト作成
- **教訓**: 新規スクリプト作成時は必ずプロジェクトのモジュール形式を確認し、ES Module形式（import/export）を使用
- **対策**: スクリプト作成前に `package.json` の `"type"` フィールドをチェック
- **発見日**: 2026-01-23
- **関連タスク**: SHARED-TYPE-EXPORT-03

---

## ガイドライン

実行時の判断基準。

### 抽象度レベル判定

- **状況**: ユーザー要求の具体性を判断する時
- **指針**: L1（概念）→ 詳細インタビュー、L2（機能）→ 軽いヒアリング、L3（実装）→ 直接実行
- **根拠**: 抽象度に応じて必要な対話量が変わる
- **発見日**: 2026-01-15

### モード選択

- **状況**: create/update/improve-prompt の選択時
- **指針**: 既存スキルパスの有無、更新対象の特定で判断
- **根拠**: detect_mode.js の判定ロジックに準拠
- **発見日**: 2026-01-06
