# スクリプト/LLM パターンガイド

> **読み込み条件**: スクリプト設計時、処理の役割分担を決定する時
> **相対パス**: `references/script-llm-patterns.md`
> **責務**: 「いつ」スクリプト/LLMを使うかの判断基準を提供

---

## 本リファレンスの責務

| 責務 | 本ファイル | 委譲先 |
|------|-----------|--------|
| **いつ使うか** | ✓ 判断基準提供 | - |
| **何を使うか** | - | [script-types-catalog.md](script-types-catalog.md) |
| **どう組み合わせるか** | - | [workflow-patterns.md](workflow-patterns.md) |

---

## 概要

スキル内の処理を「スクリプト」と「LLM」に適切に分担することで、精度と効率を最大化する。

**原則**: Script First（決定論的処理は100%精度のスクリプトで実行）

---

## 3つのパターン

| パターン | 処理担当 | 使用条件 | 精度 |
|----------|----------|----------|------|
| **決定論的** | スクリプトのみ | ルールが明確、例外なし | 100% |
| **創造的** | LLMのみ | 判断・創造・言語化が必要 | LLM依存 |
| **組み合わせ** | スクリプト→LLM | 機械的フィルタ後にLLM判断 | 高精度 |

---

## パターン1: 決定論的処理（スクリプトのみ）

### 特徴

- 入力→出力が一意に決まる
- ルール・テーブル・数式で定義可能
- 例外処理も含めて完全に定義可能

### 代表例

| 処理 | スクリプト実装方法 |
|------|-------------------|
| **配色提案** | 業種→推奨配色のマッピングテーブル |
| **レイアウト選択** | 情報量→パターン選択のルール |
| **禁止表現チェック** | 正規表現による検出 |
| **フォーマット検証** | 電話番号・URL・メールの正規表現 |
| **日付計算** | 営業日・期限の計算 |
| **ディレクトリ作成** | 命名規則に基づく自動生成 |
| **テンプレート展開** | 変数置換 |

### 実装例: 配色提案

```javascript
// 業種→配色マッピング（決定論的）
const INDUSTRY_COLORS = {
  'カフェ': { base: '#F5F0E6', main: '#8B6914', accent: '#D4A574' },
  '美容室': { base: '#FAFAFA', main: '#9C27B0', accent: '#E91E63' },
  '整体院': { base: '#E8F5E9', main: '#2E7D32', accent: '#81C784' },
};

function getColorScheme(industry) {
  return INDUSTRY_COLORS[industry] || DEFAULT_COLORS;
}
```

### 判断基準

以下の質問にすべて「はい」なら決定論的:

- [ ] 入力が同じなら出力は常に同じか？
- [ ] ルール・テーブルで完全に定義できるか？
- [ ] 人間の判断なしに実行できるか？
- [ ] 例外ケースもルール化できるか？

---

## パターン2: 創造的処理（LLMのみ）

### 特徴

- 文脈・ニュアンスの理解が必要
- 創造的な生成・言語化が必要
- 正解が一つではない

### 代表例

| 処理 | LLMが必要な理由 |
|------|----------------|
| **キャッチコピー生成** | 創造的な表現が必要 |
| **ペルソナ生成** | 情報から人物像を創造 |
| **課題分析** | 言葉から本質的課題を発見 |
| **訴求軸決定** | 競合・ターゲットから最適解を判断 |
| **ストーリー構築** | 一貫したナラティブを作成 |
| **改善提案** | 問題点から具体的な修正案を生成 |
| **ヒアリング深掘り** | ユーザーの回答から次の質問を決定 |

### 実装例: キャッチコピー生成

```
# LLMに委ねる（スクリプト化しない）

以下の情報からキャッチコピーを3案作成してください:

- ターゲット: {{persona}}
- 訴求軸: {{appeal}}
- インサイト: {{insight}}
- 制約: 15〜25文字
```

### 判断基準

以下のいずれかに該当すればLLM:

- [ ] 同じ入力でも複数の妥当な出力がありうる
- [ ] 「良い」「適切」などの主観的判断が必要
- [ ] 文脈やニュアンスの理解が必要
- [ ] 創造的な生成が必要
- [ ] 自然言語での表現・言語化が必要

---

## パターン3: 組み合わせ（スクリプト→LLM）

### 特徴

- 機械的なフィルタ・検証をスクリプトで実行
- その結果をLLMに渡して判断・対応を委ねる

### 代表例

| 処理 | スクリプト担当 | LLM担当 |
|------|---------------|---------|
| **品質チェック** | 禁止表現検出・フォーマット検証 | 総合判断・改善提案 |
| **情報収集** | 質問テンプレート提示 | 回答の解釈・深掘り |
| **プロンプト生成** | テンプレート展開・変数置換 | 表現の調整・最適化 |
| **配色決定** | 業種から基本配色を提案 | ユーザー希望との調整 |
| **レイアウト決定** | 情報量からパターン選択 | 優先順位の解釈 |

### 実装例: 品質チェック

```javascript
// スクリプト: 機械的チェック
function checkProhibited(text) {
  const issues = [];
  const patterns = [
    { regex: /絶対/g, reason: '保証できない表現' },
    { regex: /No\.1/gi, reason: '根拠が必要' },
  ];
  for (const p of patterns) {
    if (p.regex.test(text)) {
      issues.push({ pattern: p.regex.source, reason: p.reason });
    }
  }
  return issues;
}

// LLM: 総合判断と改善提案（スクリプト結果を入力として渡す）
```

```
# LLMへの指示

以下の品質チェック結果を確認し、総合判断と改善提案を行ってください:

## 検出された問題
{{script_result}}

## 判断してほしいこと
1. 総合判定（OK/要修正/NG）
2. 各問題の深刻度評価
3. 具体的な改善案（代替表現の提案）
```

### 判断基準

以下の場合は組み合わせパターン:

- [ ] 機械的に検出できるが、対応はケースバイケース
- [ ] ルールベースで候補を絞り、最終選択はLLM
- [ ] 定型処理後にカスタマイズが必要

---

## 実践的な分担設計プロセス

### Step 1: 処理の洗い出し

スキルで行う全処理をリストアップ:

```
例: チラシ作成スキル
- 課題分析
- ペルソナ生成
- 訴求軸決定
- 配色提案
- レイアウト選択
- キャッチコピー生成
- 品質チェック
- プロンプト生成
```

### Step 2: 各処理の分類

| 処理 | ルール化可能？ | 創造性必要？ | 分類 |
|------|--------------|-------------|------|
| 課題分析 | × | ○ | LLM |
| ペルソナ生成 | × | ○ | LLM |
| 訴求軸決定 | × | ○ | LLM |
| **配色提案** | **○** | △ | **スクリプト+LLM** |
| **レイアウト選択** | **○** | △ | **スクリプト+LLM** |
| キャッチコピー生成 | × | ○ | LLM |
| **品質チェック** | **○** | △ | **スクリプト+LLM** |
| プロンプト生成 | △ | △ | スクリプト+LLM |

### Step 3: スクリプト設計

スクリプト化する処理について:

1. **入力→出力のマッピングテーブル作成**
2. **例外ケースの洗い出しとルール化**
3. **境界条件の定義**

### Step 4: LLMとの接続点設計

スクリプト結果をLLMに渡す方法:

```markdown
## スクリプト実行結果

配色提案スクリプトの結果:
- ベース: {{base_color}}
- メイン: {{main_color}}
- アクセント: {{accent_color}}

この配色をベースに、ユーザーの希望「{{user_preference}}」を
考慮して最終的な配色を決定してください。
```

---

## アンチパターン

### ❌ すべてをLLMに任せる

```
問題: 精度が不安定、コスト高
例: 禁止表現チェックをLLMのみで行う
→ 見落としリスクあり

改善: スクリプトで機械的チェック後、LLMで総合判断
```

### ❌ すべてをスクリプト化しようとする

```
問題: 複雑すぎる条件分岐、メンテナンス困難
例: キャッチコピー生成をルールベースで実装
→ 創造性のない出力

改善: 創造的処理はLLMに委ねる
```

### ❌ スクリプトとLLMの役割が不明確

```
問題: 重複処理、矛盾した出力
例: 配色をスクリプトとLLM両方で独立に決定
→ 結果が一致しない

改善: スクリプト→LLMの一方向フローを明確に
```

---

## チェックリスト

スキル設計時に確認:

- [ ] 各処理の分類（決定論的/創造的/組み合わせ）を決定した
- [ ] 決定論的処理はスクリプト化した
- [ ] スクリプトからLLMへのデータフローを設計した
- [ ] LLMへの指示にスクリプト結果を含める形式を定義した
- [ ] アンチパターンに該当していないか確認した

---

## 関連リソース

| 次のステップ | 参照先 | 条件 |
|-------------|--------|------|
| スクリプトタイプ選択 | [script-types-catalog.md](script-types-catalog.md) | 決定論的/組み合わせパターン選択後 |
| ワークフロー設計 | [workflow-patterns.md](workflow-patterns.md) | 複数処理の連携が必要な場合 |
| 品質検証 | [quality-standards.md](quality-standards.md) | 設計完了後の検証時 |
| ランタイム設定 | [runtime-guide.md](runtime-guide.md) | スクリプト実装時 |
